machine:
  java:
    version: oraclejdk8
  environment:
    GRADLE_OPTS: "-Xmx2g"
    _JAVA_OPTIONS: "-Xms256m -Xmx1536m"
    CIRCLE_JDK_VERSION: oraclejdk8
    JAVA8_HOME: "/usr/lib/jvm/jdk1.8.0"
    TERM: "dumb"
    ADB_INSTALL_TIMEOUT: "10"
  post:
    # Turn off unneded services to free memory.
    - for service in "apache2" "beanstalkd" "cassandra" "couchbase-server" "couchdb" "docker" "elasticsearch" "memcached" "mongodb" "mysql" "neo4j-service" "postgresql" "puppet" "rabbitmq-server" "redis-server" "riak" "solr" "sphinxsearch" "zookeeper"; do sudo service $service stop; done


dependencies:
  pre:
    - if [ ! -e $ANDROID_HOME/platforms/android-25 ]; then for pack in "android-25" "tools" "extra-android-m2repository" "google_play_services" "extra-google-m2repository" "extra-android-support" "platform-tools"; do echo y | android update sdk -u -a -t $pack ; done ; fi
    - if [ ! -e $ANDROID_HOME/build-tools/25.0.0 ]; then echo y | android update sdk -u -a -t "build-tools-25.0.0"; fi
  override:
    - ./gradlew dependencies
  cache_directories:
    - ~/.android
    - /usr/local/android-sdk-linux/tools
    - /usr/local/android-sdk-linux/extras
    - /usr/local/android-sdk-linux/build-tools/25.0.0
  post:
    - mksdcard -l e 512M mysdcard.img
    - echo n | android create avd -n testing15 -f -t android-15


test:
  pre:
    - ./ci/launchEmu.sh $CIRCLE_NODE_INDEX:
        parallel: true
        background: true
    - ./gradlew assembleDebug check lint:
        parallel: true
    # Ensure that emulator booted
    - circle-android wait-for-boot:
        parallel: true
        background: true
    # Wait for boot seems not good enough.
    - sleep 30
    # debug print
    - adb devices:
        parallel: true
    - ci/disableAnimations.sh:
        parallel: true
    # unlocking the emulator screen
    - adb shell input keyevent 82:
        parallel: true
    - adb logcat -d:
        parallel: true
  override:
    # Run instrumented tests.
    - ci/run_instrumented_tests.sh || ci/run_instrumented_tests.sh:
        parallel: true
        timeout: 1800
  post:
    # copy the build outputs to artifacts
    - cp -r sampleapplication/build/outputs $CIRCLE_ARTIFACTS
    - cp -r SecretSauce/build/outputs $CIRCLE_ARTIFACTS
    # copy the test results to the test results directory.
    - cp -r sampleapplication/build/spoon/* $CIRCLE_TEST_REPORTS/:
        parallel: true
